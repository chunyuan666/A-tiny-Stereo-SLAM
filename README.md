# 一个简单的双目SLAM系统

## 依赖
- OpenCV
- Eigen
- Sophus
- G2O
- caffe
- DeepLCD
- Pangolin

## 编译
```
mkdir build
cd build
cmake ..
make
```
## Run
下载Kitti数据集[kitti data](http://vision.in.tum.de/data/datasets/rgbd-dataset/download)
```
./bin/stereo_kitti config/KITTI00-02.yaml Data_path/sequences/00
```
## 评估
使用[evo](https://www.freesion.com/article/60411367914/)工具对轨迹行进评估。
```
evo_traj kitti trajectory.txt KITTI_00_ORB.txt --ref=KITTI_00_gt.txt -p --plot_mode=xz
```
[效果展示]()
## 简单介绍
该系统有三大线程：
* 前端Frontend Thread
* 后端Backend Thread
* 回环LoopClosing Thread

### **前端**
初始化时，使用ORB特征点法提取特征，采用LK光流追踪特征点，使用ORBSLAM2中的八叉树方法分区域在左图提取特征点，目的是为了避免opencv提取函数的特征点过于集中的现象。在进行双目匹配时，先使用LK光流初步匹配右目特征点，再使用Ransac算法剔除错误匹配得到准确的双目匹配对。将得到的匹配对进行三角化，得到3维地图点。之后，将第一帧设为关键帧。

参考ORBSLAM2，追踪方式分为两种：恒速运动追踪、参考关键帧追踪。恒速运动追踪：对于当前帧，会根据恒速模型，得到初始粗糙位姿，用初始位姿将上一帧的地图点投影到当前帧，使用光流进行精匹配，再使用G2O进行位姿优化，仅优化位姿，地图点仅仅作为约束。参考关键帧追踪：将上一帧的位姿设为当前帧的位姿，使用该帧的参考关键帧的地图点投影到当前帧，再用光流匹配，若匹配的点数少于20，则追踪失败，点数大于20则使用G2O进行位姿优化。两种跟踪模式若跟踪上一帧的地图点小于阈值，则将该帧设为关键帧，插入后端。
系统初始化之后还没有速度，使用参考关键帧追踪。此后大部分时间都使用恒速运动追踪，若恒速运动跟丢，则使用参考关键帧跟踪，若还是跟踪失败，则进入重定位模式。

### **后端**
后端维护一个大小为10的滑动窗口，该窗口装有最新的10个关键帧和各帧的地图点。关键帧从前端送入窗口时，它所拥有的地图点会被添加观测属性，每个地图点会维护一个观测变量，观测变量记录该地图点能观测到的在滑动窗口的关键帧和被观测次数。当一个关键帧滑出窗口后，会将属于它的地图点中观测次数为0的地图点剔除出窗口。做完这些操作后，将窗口塞入G2O做局部的BA优化，更新优化后的关键帧位姿和地图点坐标。最后将优化后的关键帧送入回环模块。

### **回环**
回环模块维护一个关键帧数据库，该数据库存放来自后端优化过的关键帧，用于回环检测
预处理：从后端过来的关键帧，为克服尺度变化带来的影响，需要对特征点进行金字塔扩充，扩充为8层，在每一层中都计算描述子，这样子，每一个特征点就拥有8个不同尺度的特征描述子。此外，为检测出两帧的相似度，使用DeepLCD网络对每一个关键帧计算一个特征向量。经过上述操作后，将计算好的关键帧(带有描述子、特征向量)插入数据库。

挑选回环帧：对于当前关键帧，将它的特征向量与数据库中所有关键帧的特征向量做相似度计算，找出分数最高的关键帧，若该帧的分数高于阈值，则将它视为候选回环帧。

特征匹配：将候选回环帧的特征点与当前帧的特征点作特征匹配，挑选出描述子距离小于一定阈值的匹配点，若匹配点对超过10个，则认为匹配成功，将候选回环帧作为当前帧的回环帧。将回环帧的地图点和当前帧的特征点进行pnp求解，获得当前帧的初始位姿，然后使用g2o优化当前帧位姿，若优化内点数超过5个，则认为优化成功，得到当前帧正确的，没有漂移的位姿。

回环矫正：利用当前帧的准确位姿，对其余关键帧和地图点进行位姿矫正。首先滑动窗口中的关键帧根据与当前帧的相对位姿进行位姿矫正，滑动窗口中的地图点根据它与当前帧的位姿进行坐标矫正。

全局BA：矫正滑动窗口中的位姿后，将所有的关键帧和地图点进行BA优化，固定滑动窗口中已经矫正过的关键帧位姿和地图点位姿。添加两种约束，一种是关键帧之间的相对位姿，另一种是回环帧之间的相对位姿。优化结束，将所有的关键帧位姿和地图点坐标进行矫正。
